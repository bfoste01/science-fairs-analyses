---
title: "R Notebook"
output:
  html_document:
    theme: simplex
  html_notebook: null
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r,warning=FALSE, message=FALSE, tidy=TRUE, error=FALSE}
# import packages
pacman::p_load(MplusAutomation, psych, tidyr, foreign, ggplot2, ggalt, ggthemes, readr, dplyr, knitr, scales, wordcloud,
               tm, NLP)

# import original datasets
pre.dat <- read.spss("PreQuestionnaireData.sav", to.data.frame = TRUE, use.value.labels = FALSE)
pre.dat.labs <- read.spss("PreQuestionnaireData.sav", to.data.frame = TRUE, use.value.labels = TRUE)
post.dat <- read.spss("PostQuestionnaireData.sav", to.data.frame = TRUE, use.value.labels = FALSE)
post.dat.labs <- read.spss("PostQuestionnaireData.sav", to.data.frame = TRUE, use.value.labels = FALSE)
```

Helper functions
```{r, helpers, warning=FALSE, message=FALSE, tidy=TRUE}
## Gives count, mean, standard deviation, standard error of the mean, and confidence interval (default 95%).
##   data: a data frame.
##   measurevar: the name of a column that contains the variable to be summariezed
##   groupvars: a vector containing names of columns that contain grouping variables
##   na.rm: a boolean that indicates whether to ignore NA's
##   conf.interval: the percent range of the confidence interval (default is 95%)
summarySE <- function(data=NULL, measurevar, groupvars=NULL, na.rm=FALSE,
                      conf.interval=.95, .drop=TRUE) {
    library(plyr)

    # New version of length which can handle NA's: if na.rm==T, don't count them
    length2 <- function (x, na.rm=FALSE) {
        if (na.rm) sum(!is.na(x))
        else       length(x)
    }

    # This does the summary. For each group's data frame, return a vector with
    # N, mean, and sd
    datac <- ddply(data, groupvars, .drop=.drop,
      .fun = function(xx, col) {
        c(N    = length2(xx[[col]], na.rm=na.rm),
          mean = mean   (xx[[col]], na.rm=na.rm),
          sd   = sd     (xx[[col]], na.rm=na.rm)
        )
      },
      measurevar
    )

    # Rename the "mean" column    
    datac <- rename(datac, c("mean" = measurevar))

    datac$se <- datac$sd / sqrt(datac$N)  # Calculate standard error of the mean

    # Confidence interval multiplier for standard error
    # Calculate t-statistic for confidence interval: 
    # e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1
    ciMult <- qt(conf.interval/2 + .5, datac$N-1)
    datac$ci <- datac$se * ciMult

    return(datac)
}

## Norms the data within specified groups in a data frame; it normalizes each
## subject (identified by idvar) so that they have the same mean, within each group
## specified by betweenvars.
##   data: a data frame.
##   idvar: the name of a column that identifies each subject (or matched subjects)
##   measurevar: the name of a column that contains the variable to be summariezed
##   betweenvars: a vector containing names of columns that are between-subjects variables
##   na.rm: a boolean that indicates whether to ignore NA's
normDataWithin <- function(data=NULL, idvar, measurevar, betweenvars=NULL,
                           na.rm=FALSE, .drop=TRUE) {
    library(plyr)

    # Measure var on left, idvar + between vars on right of formula.
    data.subjMean <- ddply(data, c(idvar, betweenvars), .drop=.drop,
     .fun = function(xx, col, na.rm) {
        c(subjMean = mean(xx[,col], na.rm=na.rm))
      },
      measurevar,
      na.rm
    )

    # Put the subject means with original data
    data <- merge(data, data.subjMean)

    # Get the normalized data in a new column
    measureNormedVar <- paste(measurevar, "_norm", sep="")
    data[,measureNormedVar] <- data[,measurevar] - data[,"subjMean"] +
                               mean(data[,measurevar], na.rm=na.rm)

    # Remove this subject mean column
    data$subjMean <- NULL

    return(data)
}

## Summarizes data, handling within-subjects variables by removing inter-subject variability.
## It will still work if there are no within-S variables.
## Gives count, un-normed mean, normed mean (with same between-group mean),
##   standard deviation, standard error of the mean, and confidence interval.
## If there are within-subject variables, calculate adjusted values using method from Morey (2008).
##   data: a data frame.
##   measurevar: the name of a column that contains the variable to be summariezed
##   betweenvars: a vector containing names of columns that are between-subjects variables
##   withinvars: a vector containing names of columns that are within-subjects variables
##   idvar: the name of a column that identifies each subject (or matched subjects)
##   na.rm: a boolean that indicates whether to ignore NA's
##   conf.interval: the percent range of the confidence interval (default is 95%)
summarySEwithin <- function(data=NULL, measurevar, betweenvars=NULL, withinvars=NULL,
                            idvar=NULL, na.rm=FALSE, conf.interval=.95, .drop=TRUE) {

  # Ensure that the betweenvars and withinvars are factors
  factorvars <- vapply(data[, c(betweenvars, withinvars), drop=FALSE],
    FUN=is.factor, FUN.VALUE=logical(1))

  if (!all(factorvars)) {
    nonfactorvars <- names(factorvars)[!factorvars]
    message("Automatically converting the following non-factors to factors: ",
            paste(nonfactorvars, collapse = ", "))
    data[nonfactorvars] <- lapply(data[nonfactorvars], factor)
  }

  # Get the means from the un-normed data
  datac <- summarySE(data, measurevar, groupvars=c(betweenvars, withinvars),
                     na.rm=na.rm, conf.interval=conf.interval, .drop=.drop)

  # Drop all the unused columns (these will be calculated with normed data)
  datac$sd <- NULL
  datac$se <- NULL
  datac$ci <- NULL

  # Norm each subject's data
  ndata <- normDataWithin(data, idvar, measurevar, betweenvars, na.rm, .drop=.drop)

  # This is the name of the new column
  measurevar_n <- paste(measurevar, "_norm", sep="")

  # Collapse the normed data - now we can treat between and within vars the same
  ndatac <- summarySE(ndata, measurevar_n, groupvars=c(betweenvars, withinvars),
                      na.rm=na.rm, conf.interval=conf.interval, .drop=.drop)

  # Apply correction from Morey (2008) to the standard error and confidence interval
  #  Get the product of the number of conditions of within-S variables
  nWithinGroups    <- prod(vapply(ndatac[,withinvars, drop=FALSE], FUN=nlevels,
                           FUN.VALUE=numeric(1)))
  correctionFactor <- sqrt( nWithinGroups / (nWithinGroups-1) )

  # Apply the correction factor
  ndatac$sd <- ndatac$sd * correctionFactor
  ndatac$se <- ndatac$se * correctionFactor
  ndatac$ci <- ndatac$ci * correctionFactor

  # Combine the un-normed means with the normed results
  merge(datac, ndatac)
}
```

## Science and Engineering Practices Items

Summary stats for the SEP items for all schools, schools of interest, and each school of interest. 
```{r, warning=FALSE, message=FALSE, tidy=TRUE}
# wrangle out the SEP items for pre and post and then join
preSep <- pre.dat %>%
  select(1:16)
postSep <- post.dat %>%
  select(1:16, post38_SFparticipate)

# fully join the data frames to a pre-post
sep <- preSep %>%
  full_join(postSep) %>%
  filter(post38_SFparticipate =="Yes")

#sep < - as_data_frame(sep) # convert to tibble
colnames(sep)
# create summary of SEP by all schools 
sep <- sep %>%
  mutate(sep.1 = rowSums(select(sep, 3:16), na.rm=TRUE),
         perSep.1 = sep.1/14, 
         sep.2 = rowSums(select(sep, 17:30), na.rm=TRUE),
         perSep.2 = sep.2/14)

# create summary of SEP for schools of interest (123, 127, 322)
sep.schoolInterest <- sep %>%
  filter(SchoolID %in% c(123, 127, 322))
sep.schoolInterest <- sep.schoolInterest %>%
  mutate(sep.1 = rowSums(select(sep.schoolInterest, 3:16), na.rm=TRUE),
         perSep.1 = sep.1/14, 
         sep.2 = rowSums(select(sep.schoolInterest, 17:30), na.rm=TRUE),
         perSep.2 = sep.2/14)

# pull out percent correct for tables
mean.per.sep.1.allSchools <- mean(sep$perSep.1, na.rm = T)
mean.per.sep.2.allSchools <- mean(sep$perSep.2, na.rm = T)
mean.per.sep.1.schoolInterest <- mean(sep.schoolInterest$perSep.1, na.rm = T)
mean.per.sep.2.schoolInterest <- mean(sep.schoolInterest$perSep.2, na.rm = T)
mean.per.sep.1.school123 <- sep.schoolInterest %>%
  filter(SchoolID %in% c(123)) %>%
  summarize(mean(perSep.1))
mean.per.sep.1.school127 <- sep.schoolInterest %>%
  filter(SchoolID %in% c(127)) %>%
  summarize(mean(perSep.1))
mean.per.sep.1.school322 <- sep.schoolInterest %>%
  filter(SchoolID %in% c(322)) %>%
  summarize(mean(perSep.1))
mean.per.sep.2.school123 <- sep.schoolInterest %>%
  filter(SchoolID %in% c(123)) %>%
  summarize(mean(perSep.2))
mean.per.sep.2.school127 <- sep.schoolInterest %>%
  filter(SchoolID %in% c(127)) %>%
  summarize(mean(perSep.2))
mean.per.sep.2.school322 <- sep.schoolInterest %>%
  filter(SchoolID %in% c(322)) %>%
  summarize(mean(perSep.2))

# pull out # correct for tables
mean.sep.1.allSchools <- mean(sep$sep.1, na.rm = T)
mean.sep.2.allSchools <- mean(sep$sep.2, na.rm = T)
mean.sep.1.schoolInterest <- mean(sep.schoolInterest$sep.1, na.rm = T)
mean.sep.2.schoolInterest <- mean(sep.schoolInterest$sep.2, na.rm = T)
mean.sep.1.school123 <- sep.schoolInterest %>%
  filter(SchoolID %in% c(123)) %>%
  summarize(mean(sep.1))
mean.sep.1.school127 <- sep.schoolInterest %>%
  filter(SchoolID %in% c(127)) %>%
  summarize(mean(sep.1))
mean.sep.1.school322 <- sep.schoolInterest %>%
  filter(SchoolID %in% c(322)) %>%
  summarize(mean(sep.1))
mean.sep.2.school123 <- sep.schoolInterest %>%
  filter(SchoolID %in% c(123)) %>%
  summarize(mean(sep.2))
mean.sep.2.school127 <- sep.schoolInterest %>%
  filter(SchoolID %in% c(127)) %>%
  summarize(mean(sep.2))
mean.sep.2.school322 <- sep.schoolInterest %>%
  filter(SchoolID %in% c(322)) %>%
  summarize(mean(sep.2))
```

Create summary table for the averages of the SEP items at pre and post.
```{r, warning=FALSE, message=FALSE, tidy=TRUE, results='asis'}
# create final tibble of SEP data
SEP <- tibble(
  "Population" = c("All", "Schools of Interest", "123", "127", "322"),
  "Average Correct (Pre)" = c(mean.sep.1.allSchools, mean.sep.1.schoolInterest, mean.sep.1.school123, mean.sep.1.school127,
                                mean.sep.1.school322),
  "Average Correct (Post)"= c(mean.sep.2.allSchools, mean.sep.2.schoolInterest, mean.sep.2.school123, mean.sep.2.school127,
                                mean.sep.2.school322),
  "Average Percent Correct (Pre)" = c(mean.per.sep.1.allSchools, mean.per.sep.1.schoolInterest, mean.per.sep.1.school123, 
                                mean.per.sep.1.school127, mean.per.sep.1.school322),
  "Average Percent Correct (Post)" = c(mean.per.sep.2.allSchools, mean.per.sep.2.schoolInterest, mean.per.sep.2.school123, 
                                mean.per.sep.2.school127, mean.per.sep.2.school322)
)
kable(SEP)
```

# Plots SEP 
The plots that follow show the change (i.e., pre to post) for the total number of correct SEP items. 
```{r, warning=FALSE, message=FALSE, tidy=TRUE, results='asis'}
# http://www.cookbook-r.com/Graphs/Plotting_means_and_error_bars_(ggplot2)/#Helper%20functions
#################################################
# Plot SEP (All Schools)
#################################################
#t.test (paired)
t.test(sep$sep.2, sep$sep.1, paired = TRUE)

# munge the data to long format for easy plotting
sep.plot <- select(sep, SchoolID, StudentID, sep.1, sep.2, perSep.1, perSep.2)
sep.gathered <- gather(sep.plot, key, value, -StudentID, -SchoolID) # convert to long

#filter out the counts
sep.gathered.count <- sep.gathered %>%
  filter(key %in% c("sep.1", "sep.2"))

# summary stats from helper functions to plot
dfwc.sep.count <- summarySEwithin(sep.gathered.count, measurevar="value", withinvars="key",
    idvar="StudentID", na.rm=FALSE, conf.interval=.95)
dfwc.sep.count <- as.data.frame(dfwc.sep.count)
dfwc.sep.count$key <- as.factor(dfwc.sep.count$key)

# Make the graph with the 95% confidence interval
p.sep.count.allschools <- ggplot(dfwc.sep.count, aes(x=key, y=value, group=1)) +
  geom_line() +
  geom_errorbar(width=.1, aes(ymin=value-ci, ymax=value+ci)) +
  geom_point(shape=21, size=3, fill="white") +
  ylim(5.5,8) + 
  ggtitle("Change in Science and Engineering Practices Items", subtitle = "Differences in the average number of correct items from Time 1 to Time 2") + 
  labs(x="Time", y ="Average Correct Items", caption = "Total SEP Items = 14") +
  scale_x_discrete(labels=c("sep.1" = "Pre", "sep.2" = "Post"))

# plot with the 538 or high-charts theme
p.sep.count.allschools <- p.sep.count.allschools + theme_fivethirtyeight()
p.sep.count.allschools
ggsave("2017-10-11-p.sep.count.allschools.png", p.sep.count.allschools, width=8, height=5)
#p.sep.count.allschools + theme_hc()

#################################################
# Plot SEP (Schools of Interest)
#################################################
# munge the data to long format for easy plotting
sep.schoolInterest.plot <- select(sep.schoolInterest, SchoolID, StudentID, sep.1, sep.2, perSep.1, perSep.2)
sep.schoolInterest.gathered <- gather(sep.schoolInterest.plot, key, value, -StudentID, -SchoolID) # convert to long

#filter out the counts
sep.schoolInterest.gathered.count <- sep.schoolInterest.gathered %>%
  filter(key %in% c("sep.1", "sep.2"))
  
# summary stats from helper functions to plot
dfwc.sep.schoolInterest.count <- summarySEwithin(sep.schoolInterest.gathered.count, measurevar="value", withinvars=c("SchoolID", "key"),
    idvar="StudentID", na.rm=FALSE, conf.interval=.95)

# Make the graph with the 95% confidence interval
# The errorbars overlapped, so use position_dodge to move them horizontally
pd <- position_dodge(0.1) # move them .05 to the left and right
p.sep.count.schoolInterest <- ggplot(dfwc.sep.schoolInterest.count, aes(x=key, y=value, colour=SchoolID, group=SchoolID)) +
  geom_line(position=pd) + 
  geom_errorbar(position=pd,width=.1, aes(ymin=value-ci, ymax=value+ci)) +
  geom_point(position=pd,shape=21, fill="white") + 
  ggtitle("Change in Science and Engineering Practices Items", subtitle = "Differences in the average number of correct items from Time 1 to Time 2 for Schools of Interest") + 
  labs(x="Time", y ="Average Correct Items", caption = "Total SEP Items = 14") +
  scale_x_discrete(labels=c("sep.1" = "Pre", "sep.2" = "Post"))

# plot with the 538 or high-charts theme
p.sep.count.schoolInterest <- p.sep.count.schoolInterest + theme_fivethirtyeight()
p.sep.count.schoolInterest
ggsave("2017.10.11.p.sep.count.schoolInterest.png", p.sep.count.schoolInterest, width=8, height=5)
# p.sep.count.schoolInterest + theme_hc()
```
## Opinions About Science Items
```{r, warning=FALSE, message=FALSE, tidy=TRUE}
# wrangle out the SEP items for pre and post and then join
colnames(pre.dat)
preOpSci <- pre.dat %>%
  select(1,2,17:38)
postOpSci <- post.dat %>%
  select(1,2,17:38, post38_SFparticipate) 

# fully join the data frames to a pre-post
#OpSci <- merge(preOpSci, preOpSci, by="StudentID", all=T)
OpSci <- preOpSci %>%
  full_join(postOpSci) %>%
  filter(post38_SFparticipate =="Yes")

#OpSci < - as_data_frame(OpSci) # convert to tibble
colnames(OpSci)
# create summary of SEP by all schools 
OpSci <- OpSci %>%
  mutate(des.pre.total = rowSums(select(OpSci, contains("s_preInt_Des_")), na.rm=TRUE),
         des.pre_agree = des.pre.total/35,
         car.pre.total = rowSums(select(OpSci, contains("s_preInt_Car_")), na.rm=TRUE),
         car.pre_agree = car.pre.total/50, 
         self.pre.total = rowSums(select(OpSci, contains("s_preInt_Self_")), na.rm=TRUE),
         self.pre_agree = self.pre.total/25,
         des.post.total = rowSums(select(OpSci, contains("s_postInt_Des_")), na.rm=TRUE),
         des.post_agree = des.post.total/35,
         car.post.total = rowSums(select(OpSci, contains("s_postInt_Car_")), na.rm=TRUE),
         car.post_agree = car.post.total/50, 
         self.post.total = rowSums(select(OpSci, contains("s_postInt_Self_")), na.rm=TRUE),
         self.post_agree = self.post.total/25
         )

# aggregate the values
mean.des.pre_agree <- OpSci %>%
  summarize(mean(des.pre_agree))
mean.car.pre_agree <- OpSci %>%
  summarize(mean(car.pre_agree))
mean.self.pre_agree <- OpSci %>%
  summarize(mean(self.pre_agree))
mean.des.post_agree <- OpSci %>%
  summarize(mean(des.post_agree))
mean.car.post_agree <- OpSci %>%
  summarize(mean(car.post_agree))
mean.self.post_agree <- OpSci %>%
  summarize(mean(self.post_agree))

# create tibble
OpSci.des <- tibble(
  Subscales = c("Desire to Do Science", "Interested in Science Career", "Self-Efficacy in Science Courses"),
  pre_pct = c(mean.des.pre_agree, mean.car.pre_agree, mean.self.pre_agree),
  post_pct = c(mean.des.post_agree, mean.car.post_agree, mean.self.post_agree))
OpSci.des <- as.data.frame(OpSci.des)
OpSci.des$pre_pct <- as.numeric(OpSci.des$pre_pct)
OpSci.des$post_pct <- as.numeric(OpSci.des$post_pct)
OpSci.des$Subscales <- as.factor(OpSci.des$Subscales)
sapply(OpSci.des, class)

# Dumbell Plot
OpSci.des.long = tidyr::gather(OpSci.des, group, value, -Subscales)
p.OpSci.des <- ggplot(OpSci.des, aes(y = Subscales)) + 
     geom_point(data = OpSci.des.long, aes(x = value, color = group), size = 3) +
     geom_dumbbell(aes(x = pre_pct, xend = post_pct), size=3, color="#e3e2e1", 
                   colour_x = "#5b8124", colour_xend = "#bad744",
                   dot_guide=TRUE, dot_guide_size=0.25) +
    scale_colour_manual(name="Error Bars",values=cols, 
                        guide = guide_legend(override.aes=aes(fill=NA))) +
  labs(x="Percent Agreeableness", 
       y="Subscales", 
       title="Are Childen More Interested in Science?",
       subtitle="Changes in % agreeableness to subscales for children in all schools") +
  theme_minimal() +
  theme(panel.grid.major.x=element_line(size=0.05)) +
  theme(panel.grid.major.y=element_blank()) +
     scale_color_manual(name = "", values = c("#5b8124", "#bad744"),labels = c('Pre','Post') )

# plot with the high-charts theme
p.OpSci.des <- p.OpSci.des + theme_fivethirtyeight()
p.OpSci.des
ggsave("2017-10-11-p.OpSci.des.png", p.OpSci.des, width=8, height=5)

##################################
# schools of interest
##################################
OpSciSchoolInterest <- OpSci %>%
  filter(SchoolID %in% c("123", "127", "322")) 
# custom function 
OpSciStats <- function(dataframe){
object<-dataframe %>%
  mutate(des.pre.total = rowSums(select(dataframe, contains("s_preInt_Des_")), na.rm=TRUE),
         des.pre_agree = des.pre.total/35,
         car.pre.total = rowSums(select(dataframe, contains("s_preInt_Car_")), na.rm=TRUE),
         car.pre_agree = car.pre.total/50, 
         self.pre.total = rowSums(select(dataframe, contains("s_preInt_Self_")), na.rm=TRUE),
         self.pre_agree = self.pre.total/25,
         des.post.total = rowSums(select(dataframe, contains("s_postInt_Des_")), na.rm=TRUE),
         des.post_agree = des.post.total/35,
         car.post.total = rowSums(select(dataframe, contains("s_postInt_Car_")), na.rm=TRUE),
         car.post_agree = car.post.total/50, 
         self.post.total = rowSums(select(dataframe, contains("s_postInt_Self_")), na.rm=TRUE),
         self.post_agree = self.post.total/25
         )
return(object)
}

#summarize
OpSciSchoolInterest <- OpSciStats(OpSciSchoolInterest)
OpSciSchoolInterest_stat <- OpSciSchoolInterest %>%
  summarize(
   mean.des.pre_agree = mean(des.pre_agree),
   mean.car.pre_agree = mean(car.pre_agree),
   mean.self.pre_agree = mean(self.pre_agree),
   mean.des.post_agree = mean(des.post_agree), 
   mean.car.post_agree = mean(car.post_agree),
   mean.self.post_agree = mean(self.post_agree)
  )

# create tibble
OpSci.des.SchoolInterest <- tibble(
  Subscales = c("Desire to Do Science", "Interested in Science Career", "Self-Efficacy in Science Courses"),
  pre_pct = c(OpSciSchoolInterest_stat$mean.des.pre_agree, OpSciSchoolInterest_stat$mean.car.pre_agree, 
              OpSciSchoolInterest_stat$mean.self.pre_agree),
  post_pct = c(OpSciSchoolInterest_stat$mean.des.post_agree, OpSciSchoolInterest_stat$mean.car.post_agree, 
               OpSciSchoolInterest_stat$mean.self.post_agree))
OpSci.des.SchoolInterest <- as.data.frame(OpSci.des.SchoolInterest)
OpSci.des.SchoolInterest$pre_pct <- as.numeric(OpSci.des.SchoolInterest$pre_pct)
OpSci.des.SchoolInterest$post_pct <- as.numeric(OpSci.des.SchoolInterest$post_pct)
OpSci.des.SchoolInterest$Subscales <- as.factor(OpSci.des.SchoolInterest$Subscales)

# Dumbell Plot
OpSci.des.SchoolInterest.long = tidyr::gather(OpSci.des.SchoolInterest, group, value, -Subscales)
p.OpSci.des.SchoolInterest <- ggplot(OpSci.des.SchoolInterest, aes(y = Subscales)) + 
     geom_point(data = OpSci.des.SchoolInterest.long, aes(x = value, color = group), size = 3) +
     geom_dumbbell(aes(x = pre_pct, xend = post_pct), size=3, color="#e3e2e1", 
                   colour_x = "#5b8124", colour_xend = "#bad744",
                   dot_guide=TRUE, dot_guide_size=0.25) +
    scale_colour_manual(name="Error Bars",values=cols, 
                        guide = guide_legend(override.aes=aes(fill=NA))) +
  labs(x="Percent Agreeableness", 
       y="Subscales", 
       title="Are Childen More Interested in Science?",
       subtitle="Changes in % agreeableness to subscales for children in schools of interest",
       caption = "Schools are 123, 127, and 322") +
  theme_minimal() + 
  theme(panel.grid.major.x=element_line(size=0.05)) +
  theme(panel.grid.major.y=element_blank()) +
     scale_color_manual(name = "", values = c("#5b8124", "#bad744"),labels = c('Pre','Post') )

# plot with the high-charts theme
p.OpSci.des.SchoolInterest <- p.OpSci.des.SchoolInterest + theme_fivethirtyeight()
p.OpSci.des.SchoolInterest
ggsave("p.OpSci.des.SchoolInterest.png", p.OpSci.des.SchoolInterest, width=8, height=5)

####################################
# 123
####################################
#summarize
OpSciSchool123 <- OpSci %>%
  filter(SchoolID %in% c("123")) 
OpSciSchool123 <- OpSciStats(OpSciSchool123)
OpSciSchool123_stat <- OpSciSchool123 %>%
  summarize(
   mean.des.pre_agree = mean(des.pre_agree),
   mean.car.pre_agree = mean(car.pre_agree),
   mean.self.pre_agree = mean(self.pre_agree),
   mean.des.post_agree = mean(des.post_agree), 
   mean.car.post_agree = mean(car.post_agree),
   mean.self.post_agree = mean(self.post_agree)
  )

# create tibble
OpSci.des.School123 <- tibble(
  Subscales = c("Desire to Do Science", "Interested in Science Career", "Self-Efficacy in Science Courses"),
  pre_pct = c(OpSciSchool123_stat$mean.des.pre_agree, OpSciSchool123_stat$mean.car.pre_agree, 
              OpSciSchool123_stat$mean.self.pre_agree),
  post_pct = c(OpSciSchool123_stat$mean.des.post_agree, OpSciSchool123_stat$mean.car.post_agree, 
               OpSciSchool123_stat$mean.self.post_agree))
OpSci.des.School123 <- as.data.frame(OpSci.des.School123)
OpSci.des.School123$pre_pct <- as.numeric(OpSci.des.School123$pre_pct)
OpSci.des.School123$post_pct <- as.numeric(OpSci.des.School123$post_pct)
OpSci.des.School123$Subscales <- as.factor(OpSci.des.School123$Subscales)

# Dumbell Plot
OpSci.des.School123.long = tidyr::gather(OpSci.des.School123, group, value, -Subscales)
p.OpSci.des.School123 <- ggplot(OpSci.des.School123, aes(y = Subscales)) + 
     geom_point(data = OpSci.des.School123.long, aes(x = value, color = group), size = 3) +
     geom_dumbbell(aes(x = pre_pct, xend = post_pct), size=3, color="#e3e2e1", 
                   colour_x = "#5b8124", colour_xend = "#bad744",
                   dot_guide=TRUE, dot_guide_size=0.25) +
    scale_colour_manual(name="Error Bars",values=cols, 
                        guide = guide_legend(override.aes=aes(fill=NA))) +
  labs(x="Percent Agreeableness", 
       y="Subscales", 
       title="Are Childen More Interested in Science?",
       subtitle="Changes in % agreeableness to subscales for children in for school #123") +
  theme_minimal() + 
  theme(panel.grid.major.x=element_line(size=0.05)) +
  theme(panel.grid.major.y=element_blank()) +
     scale_color_manual(name = "", values = c("#5b8124", "#bad744"),labels = c('Pre','Post') )

# plot with the high-charts theme
p.OpSci.des.School123 <- p.OpSci.des.School123 + theme_fivethirtyeight()
p.OpSci.des.School123
ggsave("p.OpSci.des.School123.png", p.OpSci.des.School123, width=8, height=5)

####################################
# 127
####################################
#summarize
OpSciSchool127 <- OpSci %>%
  filter(SchoolID %in% c("127")) 
OpSciSchool127 <- OpSciStats(OpSciSchool127)
OpSciSchool127_stat <- OpSciSchool127 %>%
  summarize(
   mean.des.pre_agree = mean(des.pre_agree),
   mean.car.pre_agree = mean(car.pre_agree),
   mean.self.pre_agree = mean(self.pre_agree),
   mean.des.post_agree = mean(des.post_agree), 
   mean.car.post_agree = mean(car.post_agree),
   mean.self.post_agree = mean(self.post_agree)
  )

# create tibble
OpSci.des.School127 <- tibble(
  Subscales = c("Desire to Do Science", "Interested in Science Career", "Self-Efficacy in Science Courses"),
  pre_pct = c(OpSciSchool127_stat$mean.des.pre_agree, OpSciSchool127_stat$mean.car.pre_agree, 
              OpSciSchool127_stat$mean.self.pre_agree),
  post_pct = c(OpSciSchool127_stat$mean.des.post_agree, OpSciSchool127_stat$mean.car.post_agree, 
               OpSciSchool127_stat$mean.self.post_agree))
OpSci.des.School127 <- as.data.frame(OpSci.des.School127)
OpSci.des.School127$pre_pct <- as.numeric(OpSci.des.School127$pre_pct)
OpSci.des.School127$post_pct <- as.numeric(OpSci.des.School127$post_pct)
OpSci.des.School127$Subscales <- as.factor(OpSci.des.School127$Subscales)

# Dumbell Plot
OpSci.des.School127.long = tidyr::gather(OpSci.des.School127, group, value, -Subscales)
p.OpSci.des.School127 <- ggplot(OpSci.des.School127, aes(y = Subscales)) + 
     geom_point(data = OpSci.des.School127.long, aes(x = value, color = group), size = 3) +
     geom_dumbbell(aes(x = pre_pct, xend = post_pct), size=3, color="#e3e2e1", 
                   colour_x = "#5b8124", colour_xend = "#bad744",
                   dot_guide=TRUE, dot_guide_size=0.25) +
    scale_colour_manual(name="Error Bars",values=cols, 
                        guide = guide_legend(override.aes=aes(fill=NA))) +
  labs(x="Percent Agreeableness", 
       y="Subscales", 
       title="Are Childen More Interested in Science?",
       subtitle="Changes in % agreeableness to subscales for children in for school #127") +
  theme_minimal() + 
  theme(panel.grid.major.x=element_line(size=0.05)) +
  theme(panel.grid.major.y=element_blank()) +
     scale_color_manual(name = "", values = c("#5b8124", "#bad744"),labels = c('Pre','Post') )

# plot with the high-charts theme
p.OpSci.des.School127 <- p.OpSci.des.School127 + theme_fivethirtyeight()
p.OpSci.des.School127
ggsave("p.OpSci.des.School127.png", p.OpSci.des.School127, width=8, height=5)

####################################
# 322
####################################
#summarize
OpSciSchool322 <- OpSci %>%
  filter(SchoolID %in% c("322")) 
OpSciSchool322 <- OpSciStats(OpSciSchool322)
OpSciSchool322_stat <- OpSciSchool322 %>%
  summarize(
   mean.des.pre_agree = mean(des.pre_agree),
   mean.car.pre_agree = mean(car.pre_agree),
   mean.self.pre_agree = mean(self.pre_agree),
   mean.des.post_agree = mean(des.post_agree), 
   mean.car.post_agree = mean(car.post_agree),
   mean.self.post_agree = mean(self.post_agree)
  )

# create tibble
OpSci.des.School322 <- tibble(
  Subscales = c("Desire to Do Science", "Interested in Science Career", "Self-Efficacy in Science Courses"),
  pre_pct = c(OpSciSchool322_stat$mean.des.pre_agree, OpSciSchool322_stat$mean.car.pre_agree, 
              OpSciSchool322_stat$mean.self.pre_agree),
  post_pct = c(OpSciSchool322_stat$mean.des.post_agree, OpSciSchool322_stat$mean.car.post_agree, 
               OpSciSchool322_stat$mean.self.post_agree))
OpSci.des.School322 <- as.data.frame(OpSci.des.School322)
OpSci.des.School322$pre_pct <- as.numeric(OpSci.des.School322$pre_pct)
OpSci.des.School322$post_pct <- as.numeric(OpSci.des.School322$post_pct)
OpSci.des.School322$Subscales <- as.factor(OpSci.des.School322$Subscales)

# Dumbell Plot
OpSci.des.School322.long = tidyr::gather(OpSci.des.School322, group, value, -Subscales)
p.OpSci.des.School322 <- ggplot(OpSci.des.School322, aes(y = Subscales)) + 
     geom_point(data = OpSci.des.School322.long, aes(x = value, color = group), size = 3) +
     geom_dumbbell(aes(x = pre_pct, xend = post_pct), size=3, color="#e3e2e1", 
                   colour_x = "#5b8124", colour_xend = "#bad744",
                   dot_guide=TRUE, dot_guide_size=0.25) +
    scale_colour_manual(name="Error Bars",values=cols, 
                        guide = guide_legend(override.aes=aes(fill=NA))) +
  labs(x="Percent Agreeableness", 
       y="Subscales", 
       title="Are Childen More Interested in Science?",
       subtitle="Changes in % agreeableness to subscales for children in for school #322") +
  theme_minimal() + 
  theme(panel.grid.major.x=element_line(size=0.05)) +
  theme(panel.grid.major.y=element_blank()) +
     scale_color_manual(name = "", values = c("#5b8124", "#bad744"),labels = c('Pre','Post') )

# plot with the high-charts theme
p.OpSci.des.School322 <- p.OpSci.des.School322 + theme_fivethirtyeight()
p.OpSci.des.School322
ggsave("p.OpSci.des.School322.png", p.OpSci.des.School322, width=8, height=5)
```

## Reflections on the Science Fair
```{r, warning=FALSE, message=FALSE, tidy=TRUE}
# wrangle out the SEP items for pre and post and then join
reflection <- post.dat %>%
  select(1,2, post38_SFparticipate, post39_SFrating, post41_anotherSF, post47_grades, 
         postFemale, post49_Hisp)
reflection <- as.data.frame(reflection)
#reflection$post38_SFparticipate <- as.factor(reflection$post38_SFparticipate)
# trim white spaces
reflection$post38_SFparticipate <- gsub("(^\\s+)|(\\s+$)", "", 
                                        reflection$post38_SFparticipate)
reflection$post49_Hisp <- gsub("(^\\s+)|(\\s+$)", "", 
                                        reflection$post49_Hisp)
reflection$postFemale <- gsub("(^\\s+)|(\\s+$)", "", 
                                        reflection$postFemale)
# recode
reflection$post38_SFparticipate[reflection$post38_SFparticipate=="yes"] <- "Yes"
reflection$post38_SFparticipate[reflection$post38_SFparticipate=="no"] <- "No"
reflection$post38_SFparticipate[reflection$post38_SFparticipate==""] <- "Not Reported"
reflection$post49_Hisp[reflection$post49_Hisp==""] <- "Not Reported"
reflection$post49_Hisp[reflection$post49_Hisp==1] <- "Hispanic"
reflection$post49_Hisp[reflection$post49_Hisp==0] <- "Not Hispanic"
reflection$postFemale[reflection$postFemale==""] <- "Not Reported"
reflection$postFemale[reflection$postFemale==1] <- "Female"
reflection$postFemale[reflection$postFemale==0] <- "Male"
reflection[ reflection == "Not Reported" ] <- NA
reflection$postFemale <- as.factor(reflection$postFemale)
reflection$post49_Hisp <- as.factor(reflection$post49_Hisp)
reflection$post38_SFparticipate <- as.factor(reflection$post38_SFparticipate)
# # gender composition of those that took science fair
# tab.gender <- with(reflection, table(postFemale, post38_SFparticipate))
# prop.table(tab.gender, margin = 1)
# 
# # hispanic composition of those that took science fair
# tab.hisp <- with(reflection, table(post49_Hisp, post38_SFparticipate))
# test <- as.data.frame(test)

# plot propotions of hispanic taking science fair
prop.hisp <- data.frame(prop.table(table(reflection$post38_SFparticipate, reflection$post49_Hisp),2))
prop.hisp <- ggplot(prop.hisp, aes(Var1, Freq, fill = Var2)) + 
  geom_bar(position = "dodge", stat = "identity") +
  scale_y_continuous(labels=scales::percent) + 
  labs(x="Did student participate in the science fair?", 
       y="Percent", 
       title="Hispanic Students Attendance",
       subtitle="Percentage of Hispanic students who indicated they attended the science fair") +
  scale_fill_manual(values=c("#FEC44F", "#D95F0E"), 
                       name="Student Hispanic Status") +
  theme_minimal() 

# plot with the high-charts theme
prop.hisp <- prop.hisp + theme_fivethirtyeight()
prop.hisp
ggsave("2017-10-11-prop.hisp.png", prop.hisp, width=8, height=5)

# proporiton of females taking fair
prop.gen <- data.frame(prop.table(table(reflection$post38_SFparticipate, reflection$postFemale),2))
prop.gen <- ggplot(prop.gen, aes(Var1, Freq, fill = Var2)) + 
  geom_bar(position = "dodge", stat = "identity") +
  scale_y_continuous(labels=scales::percent) + 
  labs(x="Did student participate in the science fair?", 
       y="Percent", 
       title="Female Student Attendance",
       subtitle="Proportion of female students who indicated they attended the science fair") +
  scale_fill_manual(values=c("#FEC44F", "#D95F0E"), 
                       name="Student Gender Status") +
  theme_minimal() 

# plot with the high-charts theme
prop.gen <- prop.gen + theme_fivethirtyeight()
prop.gen
ggsave("2017-10-11-prop.gen.png", prop.gen, width=8, height=5)

# All attend
p.again <- ggplot(reflection, aes(x = post38_SFparticipate)) + 
  geom_bar(aes(y=..count../sum(..count..))) +
  scale_y_continuous(labels=percent_format()) + 
   labs(x="Did student participate in the science fair?", 
       y="Percent", 
       title="Students Overwhelmingly Attended the Fair",
       subtitle="Proportion of students who indicated they would attend another science fair") 
p.again <- p.again + theme_fivethirtyeight()
p.again
ggsave("2017-10-11-p.again.png", p.again, width=8, height=5)

# Gender Composition

p.gender <- ggplot(reflection, aes(x = postFemale)) + 
  geom_bar(aes(y=..count../sum(..count..))) +
  scale_y_continuous(labels=percent_format()) + 
   labs(x="Did student participate in the science fair?", 
       y="Percent", 
       title="The Gender Composition of the Sample Was Equal")
p.gender <- p.gender + theme_fivethirtyeight()
p.gender
ggsave("p.gender.png", p.gender, width=8, height=5)

# Hisapnic Composition
p.hisp <- ggplot(reflection, aes(x = post49_Hisp)) + 
  geom_bar(aes(y=..count../sum(..count..))) +
  scale_y_continuous(labels=percent_format()) + 
   labs(x="Did student participate in the science fair?", 
       y="Percent", 
       title="Hispanic Students Made Up a Third of the Sample")
p.hisp <- p.hisp + theme_fivethirtyeight()
p.hisp
ggsave("p.hisp.png", p.hisp, width=8, height=5)


# Students Rating of the Science Fair (for those who attended)
reflection.attended <- reflection %>%
  filter(post38_SFparticipate=="Yes")
reflection.attended$post39_SFrating[reflection.attended$post39_SFrating==0] <- "I hated it."
reflection.attended$post39_SFrating[reflection.attended$post39_SFrating==1] <- "I didn't like it."
reflection.attended$post39_SFrating[reflection.attended$post39_SFrating==2] <- "It was ok."
reflection.attended$post39_SFrating[reflection.attended$post39_SFrating==3] <- "I liked it."
reflection.attended$post39_SFrating[reflection.attended$post39_SFrating==4] <- "I loved it."
reflection.attended$post39_SFrating[reflection.attended$post39_SFrating==""] <- "Not Reported"
reflection.attended[ reflection.attended == "Not Reported" ] <- NA
reflection.attended$post39_SFrating <- as.factor(reflection.attended$post39_SFrating)
reflection.attended$post39_SFrating <- factor(reflection.attended$post39_SFrating, levels = c("I loved it.","I liked it.","It was ok.","I didn't like it.", "I hated it.", "NA"))
# all student review
p.all.review <- ggplot(reflection.attended, aes(x = post39_SFrating)) + 
  geom_bar(aes(y=..count../sum(..count..))) +
  scale_y_continuous(labels=percent_format()) + 
   labs(x="How did you feel about the science fair this year?", 
       y="Percent Endorsement of Category", 
       title="Most Students Rated the Fair Favorably") 
p.all.review <- p.all.review + theme_fivethirtyeight()
p.all.review
ggsave("2017-10-11-p.all.review.png", p.all.review, width=8, height=5)

# proporiton of females rating
prop.gen.review <- data.frame(prop.table(table(reflection.attended$post39_SFrating, reflection.attended$postFemale),2))
prop.gen.review <- ggplot(prop.gen.review, aes(Var1, Freq, fill = Var2)) + 
  geom_bar(position = "dodge", stat = "identity") +
  scale_y_continuous(labels=scales::percent) + 
  labs(x="How did you feel about the science fair this year?", 
       y="Percent Endorsement of Category", 
       title="Rating of Science Fair by Gender") +
  scale_fill_manual(values=c("#FEC44F", "#D95F0E"), name="Student Gender Status") +
  theme_minimal() 

# plot with the high-charts theme
prop.gen.review <- prop.gen.review + theme_fivethirtyeight()
prop.gen.review
ggsave("2017-10-11-prop.gen.review.png", prop.gen.review, width=8, height=5)

# proporiton of hispanic rating
prop.hisp.review <- data.frame(prop.table(table(reflection.attended$post39_SFrating, reflection.attended$post49_Hisp),2))
prop.hisp.review <- ggplot(prop.hisp.review, aes(Var1, Freq, fill = Var2)) + 
  geom_bar(position = "dodge", stat = "identity") +
  scale_y_continuous(labels=scales::percent) + 
  labs(x="How did you feel about the science fair this year?", 
       y="Percent Endorsement of Category", 
       title="Rating of Science Fair by Hispanic Student Status") +
  scale_fill_manual(values=c("#FEC44F", "#D95F0E"), name="Student Hispanic Status") +
  theme_minimal() 

# plot with the high-charts theme
prop.hisp.review <- prop.hisp.review + theme_fivethirtyeight()
prop.hisp.review
ggsave("2017-10-11-prop.hisp.review.png", prop.hisp.review, width=8, height=5)

# Would you do another fair? 
reflection.attended$post41_anotherSF[reflection.attended$post41_anotherSF==0] <- "Not at all."
reflection.attended$post41_anotherSF[reflection.attended$post41_anotherSF==1] <- "I'd rather not."
reflection.attended$post41_anotherSF[reflection.attended$post41_anotherSF==2] <- "I don’t care either way."
reflection.attended$post41_anotherSF[reflection.attended$post41_anotherSF==3] <- "It would be ok."
reflection.attended$post41_anotherSF[reflection.attended$post41_anotherSF==4] <- "It would be great."
reflection.attended$post41_anotherSF[reflection.attended$post41_anotherSF==""] <- "Not Reported"
reflection.attended[ reflection.attended == "Not Reported" ] <- NA
reflection.attended$post41_anotherSF <- as.factor(reflection.attended$post41_anotherSF)

reflection.attended$post41_anotherSF <- factor(reflection.attended$post41_anotherSF, levels = c("It would be great.","It would be ok.","I don’t care either way.","I'd rather not.", "Not at all.", "NA"))

# all student again
p.all.again <- ggplot(reflection.attended, aes(x = post41_anotherSF)) + 
  geom_bar(aes(y=..count../sum(..count..))) +
  scale_y_continuous(labels=percent_format()) + 
   labs(x="Would you like to do another science fair next year?", 
       y="Percent Endorsement of Category", 
       title="Students Would Generally Do Another Fair") 
p.all.again <- p.all.again + theme_fivethirtyeight()
p.all.again
ggsave("2017-10-11-p.all.again.png", p.all.again, width=8, height=5)

# proporiton of females again
prop.gen.again <- data.frame(prop.table(table(reflection.attended$post41_anotherSF, reflection.attended$postFemale),2))
p.prop.gen.again <- ggplot(prop.gen.again, aes(Var1, Freq, fill = Var2)) + 
  geom_bar(position = "dodge", stat = "identity") +
  scale_y_continuous(labels=scales::percent) + 
  labs(x="Would you like to do another science fair next year?", 
       y="Percent Endorsement of Category", 
       title="Likelihood of Doing Another Fair by Gender") +
  scale_fill_manual(values=c("#FEC44F", "#D95F0E"), name="Student Gender Status") +
  theme_minimal() 

# plot with the high-charts theme
p.prop.gen.again <- p.prop.gen.again + theme_fivethirtyeight()
p.prop.gen.again
ggsave("2017-10-11-prop.gen.again.png", prop.gen.again, width=8, height=5)

# proporiton of hispanic again
prop.hisp.again <- data.frame(prop.table(table(reflection.attended$post41_anotherSF, reflection.attended$post49_Hisp),2))
p.prop.hisp.again <- ggplot(prop.hisp.again, aes(Var1, Freq, fill = Var2)) + 
  geom_bar(position = "dodge", stat = "identity") +
  scale_y_continuous(labels=scales::percent) + 
  labs(x="Would you like to do another science fair next year?", 
       y="Percent Endorsement of Category", 
       title="Likelihood of Doing Another Fair by Hispanic Student Status") +
  scale_fill_manual(values=c("#FEC44F", "#D95F0E"), name="Student hispder Status") +
  theme_minimal() 

# plot with the high-charts theme
p.prop.hisp.again <- p.prop.hisp.again + theme_fivethirtyeight()
p.prop.hisp.again
ggsave("2017-10-11-prop.hisp.again.png", prop.hisp.again, width=8, height=5)

```

```{r}
#####################################
# create word cloud change science
#####################################
#post.dat$post40_SFrating_expl <- as.factor(post.dat$post40_SFrating_expl)
jeopCorpus <- Corpus(VectorSource(post.dat$post37_changesci))
jeopCorpus <- tm_map(jeopCorpus, content_transformer(tolower))
jeopCorpus <- tm_map(jeopCorpus, removeWords, stopwords('english'), lazy=TRUE)
#jeopCorpus <- tm_map(jeopCorpus, stemDocument)
jeopCorpus <- tm_map(jeopCorpus, removePunctuation)
jeopCorpus <- tm_map(jeopCorpus, PlainTextDocument)
png("reason.rate.png", width=8, height=5, units="in", res=300)
wordcloud(jeopCorpus, max.words = 100, random.order = FALSE)

#####################################
# create word cloud reason for rating
#####################################
#post.dat$post40_SFrating_expl <- as.factor(post.dat$post40_SFrating_expl)
jeopCorpus <- Corpus(VectorSource(post.dat$post40_SFrating_expl))
jeopCorpus <- tm_map(jeopCorpus, content_transformer(tolower))
jeopCorpus <- tm_map(jeopCorpus, removeWords, stopwords('english'), lazy=TRUE)
#jeopCorpus <- tm_map(jeopCorpus, stemDocument)
jeopCorpus <- tm_map(jeopCorpus, removePunctuation)
jeopCorpus <- tm_map(jeopCorpus, PlainTextDocument)
png("reason.rate.png", width=8, height=5, units="in", res=300)
wordcloud(jeopCorpus, max.words = 100, random.order = FALSE)
```

# Student Perception of What they gained from participating
```{r}
colnames(post.dat)
gains <- select(post.dat, 56:69, post38_SFparticipate)
gains.filter <- gains %>%
  filter(post38_SFparticipate=="Yes")
colnames(gains)
sum.gains <- gains %>%
  summarize(
    "I think science is more interesting to me now than it was before." = 
      (sum(post42_1_moreint, na.rm=T)/length(post42_1_moreint)),
    "I got to investigate something I was really interested in." = 
      (sum(post42_2_somethingint, na.rm=T)/length(post42_2_somethingint)),
    "I did something I’ve never done before." = 
      (sum(post42_3_neverbefore, na.rm=T)/length(post42_3_neverbefore)),
    "I got to study something that’s important in real life." = 
      (sum(post42_4_impreallife, na.rm=T)/length(post42_4_impreallife)),
    "I won a prize for my science fair project." = 
      (sum(post42_5_prize, na.rm=T)/length(post42_5_prize)),
    "I got to be in charge of learning something." = 
      (sum(post42_6_incharge, na.rm=T)/length(post42_6_incharge)),
    "I got to work on a team with other students." = 
      (sum(post42_7_team, na.rm=T)/length(post42_7_team)),
    "I think doing science investigations is easier now than it was before." = 
      (sum(post42_8_easier, na.rm=T)/length(post42_8_easier)),
    "I know more science now than I did before." = 
      (sum(post42_9_knowmore, na.rm=T)/length(post42_9_knowmore)),
    "I didn’t get anything out of being in the science fair." = 
      (sum(post42_10_nothing, na.rm=T)/length(post42_10_nothing)),
    "I didn’t get anything out of being in the science fair." = 
      (sum(post42_11_dislike, na.rm=T)/length(post42_11_dislike))
    )
sum.gains<- gather(sum.gains, question, percent)
kable(sum.gains)

# plot 
sum.gains$percent <- round(sum.gains$percent, 2)
sum.gains$percent.100 <- sum.gains$percent*100
sum.gains %>%
  arrange(percent.100)
#create lolipop plot
p.gains <- ggplot(sum.gains, aes(x=reorder(`question`, percent.100), y=percent.100, label=percent.100)) + 
  geom_point(stat='identity', fill="black", size=8)  +
  geom_segment(aes(y = 0, 
                   x = `question`, 
                   yend = percent.100, 
                   xend = `question`), 
               color = "black") +
  geom_text(color="white", size=2) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 7.5)) + 
  labs(title="Perception of Benefits",
       subtitle="What did you get out of participating in science fair?",
       x="Item Prompts",
       y="Percent of Students Endorsing") +
    ylim(0,100) +
  coord_flip()

p.gains
ggsave("2017-10-11-2017-10-11-p.gains.png", p.gains, width=8, height=5)
```


```{r}
# wrangle out the SEP items for pre and post and then join
colnames(pre.dat)
preOpSci <- pre.dat %>%
  select(1,2,17:38)
postOpSci <- post.dat %>%
  select(1,2,17:38, post38_SFparticipate) 

# fully join the data frames to a pre-post
#OpSci <- merge(preOpSci, preOpSci, by="StudentID", all=T)
OpSci <- preOpSci %>%
  full_join(postOpSci) %>%
  filter(post38_SFparticipate =="Yes")
OpSciSchoolInterest <- OpSci %>%
  filter(SchoolID %in% c("123", "127", "322")) 

# custom function 
OpSciStats <- function(dataframe){
object<-dataframe %>%
  mutate(des.1.total = rowSums(select(dataframe, contains("s_preInt_Des_")), na.rm=TRUE),
         des.1_agree = des.1.total/35,
         car.1.total = rowSums(select(dataframe, contains("s_preInt_Car_")), na.rm=TRUE),
         car.1_agree = car.1.total/50, 
         self.1.total = rowSums(select(dataframe, contains("s_preInt_Self_")), na.rm=TRUE),
         self.1_agree = self.1.total/25,
         des.2.total = rowSums(select(dataframe, contains("s_postInt_Des_")), na.rm=TRUE),
         des.2_agree = des.2.total/35,
         car.2.total = rowSums(select(dataframe, contains("s_postInt_Car_")), na.rm=TRUE),
         car.2_agree = car.2.total/50, 
         self.2.total = rowSums(select(dataframe, contains("s_postInt_Self_")), na.rm=TRUE),
         self.2_agree = self.2.total/25
         )
return(object)
}

OpSciSchoolInterest.plot <- select(OpSciSchoolInterest, SchoolID, StudentID, des.1.total, des.2.total, car.1.total, car.2.total, self.1.total, self.2.total)

OpSciSchoolInterest.gathered <- gather(OpSciSchoolInterest.plot, key, value, -StudentID, -SchoolID) 

#######################
# Desire
#######################

#filter out the counts
OpSciSchoolInterest.des.gathered.count <- OpSciSchoolInterest.gathered %>%
  filter(key %in% c("des.1.total", "des.2.total"))
  
# summary stats from helper functions to plot
dfwc.OpSciSchoolInterest.des.gathered.count  <- summarySEwithin(OpSciSchoolInterest.des.gathered.count, measurevar="value", withinvars=c("SchoolID", "key"), idvar="StudentID", na.rm=FALSE, conf.interval=.95)

# Make the graph with the 95% confidence interval
# The errorbars overlapped, so use position_dodge to move them horizontally
pd <- position_dodge(0.1) # move them .05 to the left and right
p.dfwc.OpSciSchoolInterest.des.gathered.count <- ggplot(dfwc.OpSciSchoolInterest.des.gathered.count, aes(x=key, y=value, colour=SchoolID, group=SchoolID)) +
  geom_line(position=pd) + 
  geom_errorbar(position=pd,width=.1, aes(ymin=value-ci, ymax=value+ci)) +
  geom_point(position=pd,shape=21, fill="white") + 
  ggtitle("Change in Desire to Do Science Items", subtitle = "Differences in the total score for the items from Time 1 to Time 2 for schools of interest") + 
  labs(x="Time", y ="Average Correct Items", caption = "Total Items = 7") +
  scale_x_discrete(labels=c("des.1.total" = "Pre", "des.2.total" = "Post"))

# plot with the 538 or high-charts theme
p.dfwc.OpSciSchoolInterest.des.gathered.count <- p.dfwc.OpSciSchoolInterest.des.gathered.count + theme_fivethirtyeight()
p.dfwc.OpSciSchoolInterest.des.gathered.count
ggsave("2017.10.11.p.dfwc.OpSciSchoolInterest.des.gathered.count.png", p.dfwc.OpSciSchoolInterest.des.gathered.count, width=8, height=5)

#######################
# Career
#######################

#filter out the counts
OpSciSchoolInterest.car.gathered.count <- OpSciSchoolInterest.gathered %>%
  filter(key %in% c("car.1.total", "car.2.total"))
  
# summary stats from helper functions to plot
dfwc.OpSciSchoolInterest.car.gathered.count  <- summarySEwithin(OpSciSchoolInterest.car.gathered.count, measurevar="value", withinvars=c("SchoolID", "key"), idvar="StudentID", na.rm=FALSE, conf.interval=.95)

# Make the graph with the 95% confidence interval
# The errorbars overlapped, so use position_dodge to move them horizontally
pd <- position_dodge(0.1) # move them .05 to the left and right
p.dfwc.OpSciSchoolInterest.car.gathered.count <- ggplot(dfwc.OpSciSchoolInterest.car.gathered.count, aes(x=key, y=value, colour=SchoolID, group=SchoolID)) +
  geom_line(position=pd) + 
  geom_errorbar(position=pd,width=.1, aes(ymin=value-ci, ymax=value+ci)) +
  geom_point(position=pd,shape=21, fill="white") + 
  ggtitle("Change in Career Interest in Science Items", subtitle = "Differences in the total score for the items from Time 1 to Time 2 for schools of interest") + 
  labs(x="Time", y ="Average Correct Items", caption = "Total Items = 10") +
  scale_x_discrete(labels=c("car.1.total" = "Pre", "car.2.total" = "Post"))

# plot with the 538 or high-charts theme
p.dfwc.OpSciSchoolInterest.car.gathered.count <- p.dfwc.OpSciSchoolInterest.car.gathered.count + theme_fivethirtyeight()
p.dfwc.OpSciSchoolInterest.car.gathered.count
ggsave("2017.10.11.p.dfwc.OpSciSchoolInterest.car.gathered.count.png", p.dfwc.OpSciSchoolInterest.car.gathered.count, width=8, height=5)

#######################
# Self-interest
#######################

#filter out the counts
OpSciSchoolInterest.self.gathered.count <- OpSciSchoolInterest.gathered %>%
  filter(key %in% c("self.1.total", "self.2.total"))
  
# summary stats from helper functions to plot
dfwc.OpSciSchoolInterest.self.gathered.count  <- summarySEwithin(OpSciSchoolInterest.self.gathered.count, measurevar="value", withinvars=c("SchoolID", "key"), idvar="StudentID", na.rm=FALSE, conf.interval=.95)

# Make the graph with the 95% confidence interval
# The errorbars overlapped, so use position_dodge to move them horizontally
pd <- position_dodge(0.1) # move them .05 to the left and right
p.dfwc.OpSciSchoolInterest.self.gathered.count <- ggplot(dfwc.OpSciSchoolInterest.self.gathered.count, aes(x=key, y=value, colour=SchoolID, group=SchoolID)) +
  geom_line(position=pd) + 
  geom_errorbar(position=pd,width=.1, aes(ymin=value-ci, ymax=value+ci)) +
  geom_point(position=pd,shape=21, fill="white") + 
  ggtitle("Change in Self Concept in Science Items", subtitle = "Differences in the total score for the items from Time 1 to Time 2 for schools of interest") + 
  labs(x="Time", y ="Average Correct Items", caption = "Total Items = 5") +
  scale_x_discrete(labels=c("self.1.total" = "Pre", "self.2.total" = "Post"))

# plot with the 538 or high-charts theme
p.dfwc.OpSciSchoolInterest.self.gathered.count <- p.dfwc.OpSciSchoolInterest.self.gathered.count + theme_fivethirtyeight()
p.dfwc.OpSciSchoolInterest.self.gathered.count
ggsave("2017.10.11.p.dfwc.OpSciSchoolInterest.self.gathered.count.png", p.dfwc.OpSciSchoolInterest.self.gathered.count, width=8, height=5)
```

```{r}
#summarize
OpSciAll <- OpSciStats(OpSci)

OpSciAll.plot <- select(OpSciAll, SchoolID, StudentID, des.1.total, des.2.total, car.1.total, car.2.total, self.1.total, self.2.total)

OpSciAll.gathered <- gather(OpSciAll.plot, key, value, -StudentID, -SchoolID) 

#######################
# Desire
#######################

#filter out the counts
OpSciAll.des.gathered.count <- OpSciAll.gathered %>%
  filter(key %in% c("des.1.total", "des.2.total"))
  
# summary stats from helper functions to plot
dfwc.OpSciAll.des.gathered.count  <- summarySE(OpSciAll.des.gathered.count, measurevar="value", groupvars="key", na.rm=FALSE, conf.interval=.95)

# Make the graph with the 95% confidence interval
# The errorbars overlapped, so use position_dodge to move them horizontally
p.dfwc.OpSciAll.des.gathered.count <- ggplot(dfwc.OpSciAll.des.gathered.count, aes(x=key, y=value, group=1)) +
  geom_line() + 
  geom_errorbar(position=pd,width=.1, aes(ymin=value-ci, ymax=value+ci)) +
  geom_point(position=pd,shape=21, size=3, fill="white") + 
  ggtitle("Change in Desire to Do Science Items", subtitle = "Differences in the total score for the whole sample Time 1 to Time 2 for schools of interest") + 
  labs(x="Time", y ="Average Correct Items", caption = "Total Items = 7") +
  scale_x_discrete(labels=c("des.1.total" = "Pre", "des.2.total" = "Post"))

# plot with the 538 or high-charts theme
p.dfwc.OpSciAll.des.gathered.count <- p.dfwc.OpSciAll.des.gathered.count + theme_fivethirtyeight()
p.dfwc.OpSciAll.des.gathered.count
ggsave("2017.10.11.p.dfwc.OpSciAll.des.gathered.count.png", p.dfwc.OpSciAll.des.gathered.count, width=8, height=5)

#######################
# Career
#######################

#filter out the counts
OpSciAll.car.gathered.count <- OpSciAll.gathered %>%
  filter(key %in% c("car.1.total", "car.2.total"))
  
# summary stats from helper functions to plot
dfwc.OpSciAll.car.gathered.count  <- summarySEwithin(OpSciAll.car.gathered.count, measurevar="value", withinvars=c("key"), idvar="StudentID", na.rm=FALSE, conf.interval=.95)

# Make the graph with the 95% confidence interval
# The errorbars overlapped, so use position_dodge to move them horizontally
p.dfwc.OpSciAll.car.gathered.count <- ggplot(dfwc.OpSciAll.car.gathered.count, aes(x=key, y=value, group=1)) +
  geom_line() + 
  geom_errorbar(position=pd,width=.1, aes(ymin=value-ci, ymax=value+ci)) +
  geom_point(position=pd,shape=21, size=3, fill="white") + 
  ggtitle("Change in Career Interest In Science Items", subtitle = "Differences in the total score for the whole sample Time 1 to Time 2 for schools of interest") + 
  labs(x="Time", y ="Average Correct Items", caption = "Total Items = 10") +
  scale_x_discrete(labels=c("car.1.total" = "Pre", "car.2.total" = "Post"))

# plot with the 538 or high-charts theme
p.dfwc.OpSciAll.car.gathered.count <- p.dfwc.OpSciAll.car.gathered.count + theme_fivethirtyeight()
p.dfwc.OpSciAll.car.gathered.count
ggsave("2017.10.11.p.dfwc.OpSciAll.car.gathered.count.png", p.dfwc.OpSciAll.car.gathered.count, width=8, height=5)

#######################
# Self
#######################

#filter out the counts
OpSciAll.self.gathered.count <- OpSciAll.gathered %>%
  filter(key %in% c("self.1.total", "self.2.total"))
  
# summary stats from helper functions to plot
dfwc.OpSciAll.self.gathered.count  <- summarySEwithin(OpSciAll.self.gathered.count, measurevar="value", withinvars=c("key"), idvar="StudentID", na.rm=FALSE, conf.interval=.95)

# Make the graph with the 95% confidence interval
# The errorbars overlapped, so use position_dodge to move them horizontally
p.dfwc.OpSciAll.self.gathered.count <- ggplot(dfwc.OpSciAll.self.gathered.count, aes(x=key, y=value, group=1)) +
  geom_line() + 
  geom_errorbar(position=pd,width=.1, aes(ymin=value-ci, ymax=value+ci)) +
  geom_point(position=pd,shape=21, size=3, fill="white") + 
  ggtitle("Change in Self Concept In Science Items", subtitle = "Differences in the total score for the whole sample Time 1 to Time 2 for schools of interest") + 
  labs(x="Time", y ="Average Correct Items", caption = "Total Items = 5") +
  scale_x_discrete(labels=c("self.1.total" = "Pre", "self.2.total" = "Post"))

# plot with the 538 or high-charts theme
p.dfwc.OpSciAll.self.gathered.count <- p.dfwc.OpSciAll.self.gathered.count + theme_fivethirtyeight()
p.dfwc.OpSciAll.self.gathered.count
ggsave("2017.10.11.p.dfwc.OpSciAll.self.gathered.count.png", p.dfwc.OpSciAll.self.gathered.count, width=8, height=5)

```
